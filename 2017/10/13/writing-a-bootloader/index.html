<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Writing a Bootloader Part 1 | Alex Parker&#39;s Website</title>
  <meta name="author" content="Alex Parker">
  
  <meta name="description" content="This post describes how to write a simple Hello world bootloader">
  
  
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <meta property="og:title" content="Writing a Bootloader Part 1"/>
  <meta property="og:site_name" content="3zanders.co.uk"/>

  <link href="/css/images/logo.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="3zanders.co.uk" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
  <header id="header"><div id="headerinner">
	<div class="alignleft">
	<a href="/"><h1>
		  	3zanders.co.uk<br/>
		  	<small>Alex Parker&#39;s Website</small>
	</h1></a>
	</div>
	<nav id="main-nav" class="alignright">
	  <ul>
	    
	      <li><a href="/">Home</a></li>
	    
	      <li><a href="/portfolio">Portfolio</a></li>
	    
	      <li><a href="/articles">Articles</a></li>
	    
	  </ul>
	  <div class="clearfix"></div>
	</nav>
	<div class="clearfix"></div>
</div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <time datetime="2017-10-12T23:00:00.000Z"><a href="/2017/10/13/writing-a-bootloader/">Oct 13 2017</a></time>
      
      
  
    <h1 class="title">Writing a Bootloader Part 1</h1>
  

    </header>
    <div class="entry">
      
        <p>This article series explains how to write a tiny 32-bit x86 operating system kernel. We won’t do very much other than print <code>Hello world!</code> to the screen in increasingly complicated ways! We’ll start off in assembly and then build up to writing C++!</p>
<p>A <a href="/2017/10/13/writing-a-bootloader/writingabootloader.pdf">presentation</a> of this article series is also available.</p>
<p>To follow along you’re going to need the NASM assembler and <a href="https://www.qemu.org/" target="_blank" rel="external">QEMU</a> to emulate a virtual machine for us. QEMU is great because you don’t have to worry about accidentally destroying your hardware with badly written OS code ;) You can install these on <a href="https://msdn.microsoft.com/en-gb/commandline/wsl/install_guide" target="_blank" rel="external">Windows Subsystem for Linux</a> or Ubuntu with this command:</p>
<pre><code>sudo apt-get install nasm qemu
</code></pre><p>On a mac you can use homebrew:</p>
<pre><code>brew install nasm
</code></pre><h2 id="A-Hello-World-Bootloader"><a href="#A-Hello-World-Bootloader" class="headerlink" title="A Hello World Bootloader"></a>A Hello World Bootloader</h2><p>When you press the power button the computer loads the BIOS from some flash memory stored on the motherboard. The BIOS initializes and self tests the hardware then loads the first 512 bytes into memory from the media device (i.e. the cdrom or floppy disk). If the last two bytes equal <code>0xAA55</code> then the BIOS will jump to location <code>0x7C00</code> effectively transferring control to the bootloader. </p>
<p>At this point the CPU is running in 16 bit mode, meaning only the 16 bit registers are available. Also since the BIOS only loads the first 512 bytes this means our bootloader code has to stay below that limit, otherwise we’ll hit uninitialised memory!</p>
<p>Let’s get hello world printing to the screen. To do this we’re going to use the ‘Write Character in TTY mode’ <a href="https://en.wikipedia.org/wiki/BIOS_interrupt_call" target="_blank" rel="external">BIOS Interrupt Call</a> and the load string byte instruction <code>lobsb</code> which loads byte at address <code>ds:si</code> into <code>al</code>. Here goes:</p>
<pre><code>bits 16 ; tell NASM this is 16 bit code
org 0x7c00 ; tell NASM to start outputting stuff at offset 0x7c00
boot:
    mov si,hello ; point si register to hello label memory location
    mov ah,0x0e ; 0x0e means &apos;Write Character in TTY mode&apos;
.loop:
    lodsb
    or al,al ; is al == 0 ?
    jz halt  ; if (al == 0) jump to halt label
    int 0x10 ; runs BIOS interrupt 0x10 - Video Services
    jmp .loop
halt:
    cli ; clear interrupt flag
    hlt ; halt execution
hello: db &quot;Hello world!&quot;,0

times 510 - ($-$$) db 0 ; pad remaining 510 bytes with zeroes
dw 0xaa55 ; magic bootloader magic - marks this 512 byte sector bootable!
</code></pre><p>If you save this file as <code>boot1.asm</code> (or <a href="/2017/10/13/writing-a-bootloader/boot1.asm">download it here</a>) we can now use <code>nasm</code> to compile it:</p>
<pre><code>nasm -f bin boot1.asm -o boot1.bin
</code></pre><p>If we run <code>hexdump boot1.bin</code> we can see that NASM created some code, padded some zeros then set the final two bytes to the magic number.</p>
<pre><code>0000000 be 10 7c b4 0e ac 08 c0 74 04 cd 10 eb f7 fa f4
0000010 48 65 6c 6c 6f 20 77 6f 72 6c 64 21 00 00 00 00
0000020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
*
00001f0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 aa
0000200
</code></pre><p>We can now run this thing! You can tell QEMU to boot off a floppy disk using <code>qemu-system-x86_64 -fda boot1.bin</code> on Windows 10 you might need to stick <code>DISPLAY=:0</code> in front to open the window from WSL. You should get something like this!</p>
<p><img src="/2017/10/13/writing-a-bootloader/boot1.png" alt="Our Hello World bootloader"></p>
<h2 id="Next-Steps"><a href="#Next-Steps" class="headerlink" title="Next Steps"></a>Next Steps</h2><p>Next we can start investigating getting into Protected Mode in <a href="/2017/10/16/writing-a-bootloader2/">Part 2</a>!</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Articles/">Articles</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/C/">C</a>, <a href="/tags/OSdev/">OSdev</a>, <a href="/tags/asm/">asm</a>
  </div>

        <!---->
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

<script data-isso="//box.3zanders.co.uk/" src="//box.3zanders.co.uk/js/embed.min.js"></script>
<section id="isso-thread"></section>
</div></div>
    <aside id="sidebar" class="alignright">

  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Suche">
    <input type="hidden" name="q" value="site:3zanders.co.uk">
  </form>
</div>

  <div class="widget tag">
  <h3 class="title">Portfolio</h3>
  <ul class="entry">
  
    <li><a href="/2009/06/10/PlayWithYourPeas/">PlayWithYourPeas</a></li>
  
    <li><a href="/2009/08/09/Book-Galaxy/">Book Galaxy</a></li>
  
    <li><a href="/2011/05/11/Detour/">Detour</a></li>
  
    <li><a href="/2011/11/12/Trapped/">Trapped</a></li>
  
    <li><a href="/2011/11/25/Kinect-Sports-Season-Two/">Kinect Sports: Season Two</a></li>
  
    <li><a href="/2012/04/12/Wikitime/">Wikitime</a></li>
  
    <li><a href="/2012/12/12/CSR-Racing/">CSR Racing</a></li>
  
    <li><a href="/2013/01/27/Dungeon-Heart/">Dungeon Heart</a></li>
  
    <li><a href="/2013/10/05/CSR-Classics/">CSR Classics</a></li>
  
    <li><a href="/2014/03/15/allRGB/">allRGB Rainbow Fractal</a></li>
  
    <li><a href="/2015/09/25/JSONParser/">C# JSON Parser</a></li>
  
    <li><a href="/2016/07/10/GLWT/">GLWT</a></li>
  
    <li><a href="/2017/08/03/GBemulator/">GB Emulator</a></li>
  
  </ul>
</div>

  <div class="widget tag">
  <h3 class="title">Articles</h3>
  <ul class="entry">
  
    <li><a href="/2014/02/19/modern-opengl-a-tutorial/">Modern Open GL Drawing a Triangle</a></li>
  
    <li><a href="/2014/08/31/new-beginnings/">New Shiny</a></li>
  
    <li><a href="/2017/10/13/writing-a-bootloader/">Writing a Bootloader Part 1</a></li>
  
    <li><a href="/2017/10/16/writing-a-bootloader2/">Writing a Bootloader Part 2</a></li>
  
    <li><a href="/2017/10/18/writing-a-bootloader3/">Writing a Bootloader Part 3</a></li>
  
  </ul>
</div>

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Actionscript/">Actionscript</a><small>1</small></li>
  
    <li><a href="/tags/Android/">Android</a><small>2</small></li>
  
    <li><a href="/tags/C/">C</a><small>4</small></li>
  
    <li><a href="/tags/C/">C#</a><small>7</small></li>
  
    <li><a href="/tags/C/">C++</a><small>6</small></li>
  
    <li><a href="/tags/DirectX/">DirectX</a><small>1</small></li>
  
    <li><a href="/tags/HLSL/">HLSL</a><small>1</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>2</small></li>
  
    <li><a href="/tags/Javascript/">Javascript</a><small>1</small></li>
  
    <li><a href="/tags/Lucene/">Lucene</a><small>1</small></li>
  
    <li><a href="/tags/OSX/">OSX</a><small>1</small></li>
  
    <li><a href="/tags/OSdev/">OSdev</a><small>3</small></li>
  
    <li><a href="/tags/Objective-C/">Objective-C</a><small>1</small></li>
  
    <li><a href="/tags/OpenGL/">OpenGL</a><small>1</small></li>
  
    <li><a href="/tags/Unity/">Unity</a><small>4</small></li>
  
    <li><a href="/tags/XNA/">XNA</a><small>1</small></li>
  
    <li><a href="/tags/Xbox-360/">Xbox 360</a><small>1</small></li>
  
    <li><a href="/tags/asm/">asm</a><small>3</small></li>
  
    <li><a href="/tags/iOS/">iOS</a><small>2</small></li>
  
  </ul>
</div>


</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer"><div id="footerinner">
	<p style="float:right">
		Built with <a href="http://hexo.io/">Hexo</a><br/>
		Hosted on <a href="https://github.com/zanders3/zanders3.github.com">GitHub Pages</a>
	</p>
	<p>
		<a href="http://www.twitter.com/3zanders">Twitter</a> | <a href="http://uk.linkedin.com/pub/alex-parker/3a/44/9">Linked In</a> | <a href="http://www.github.com/zanders3">GitHub</a>
	</p>
	<p>&copy; 2017 Alex Parker</p>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>